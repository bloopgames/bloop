#!/usr/bin/env bash
set -euo pipefail

# Cross-platform setup script for Bloop (macOS/Linux)
# Checks for Bun and Zig, offers to install if missing, warns on version mismatch

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Default versions (overridden by setup.config)
BUN_MIN_VERSION="1.3.1"
ZIG_MIN_VERSION="0.16.0-dev.1225"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

print_header() {
    echo -e "${CYAN}=== $1 ===${NC}"
}

print_success() {
    echo -e "${GREEN}$1${NC}"
}

print_warning() {
    echo -e "${YELLOW}$1${NC}"
}

print_error() {
    echo -e "${RED}$1${NC}"
}

# Load configuration from setup.config
load_config() {
    local config_file="$PROJECT_ROOT/setup.config"
    if [[ ! -f "$config_file" ]]; then
        print_warning "Warning: setup.config not found, using defaults"
        return
    fi

    while IFS='=' read -r key value || [[ -n "$key" ]]; do
        # Skip comments and empty lines
        [[ "$key" =~ ^[[:space:]]*# ]] && continue
        [[ -z "${key// }" ]] && continue

        # Trim whitespace
        key=$(echo "$key" | xargs)
        value=$(echo "$value" | xargs)

        case "$key" in
            BUN_MIN_VERSION) BUN_MIN_VERSION="$value" ;;
            ZIG_MIN_VERSION) ZIG_MIN_VERSION="$value" ;;
        esac
    done < "$config_file"
}

# Parse zig version string into comparable parts
# Input: "0.16.0-dev.1225+bf9082518" or "0.16.0"
# Output: "major minor patch dev" (space-separated)
parse_zig_version() {
    local version="$1"

    # Dev version: 0.16.0-dev.1225+hash
    if [[ "$version" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)-dev\.([0-9]+) ]]; then
        echo "${BASH_REMATCH[1]} ${BASH_REMATCH[2]} ${BASH_REMATCH[3]} ${BASH_REMATCH[4]}"
    # Stable version: 0.16.0 (treat as higher than any dev of same base)
    elif [[ "$version" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
        echo "${BASH_REMATCH[1]} ${BASH_REMATCH[2]} ${BASH_REMATCH[3]} 999999"
    else
        echo "0 0 0 0"
    fi
}

# Compare two zig versions
# Returns 0 (true) if $1 >= $2
zig_version_gte() {
    local current="$1"
    local required="$2"

    read -r c_major c_minor c_patch c_dev <<< "$(parse_zig_version "$current")"
    read -r r_major r_minor r_patch r_dev <<< "$(parse_zig_version "$required")"

    [[ $c_major -gt $r_major ]] && return 0
    [[ $c_major -lt $r_major ]] && return 1
    [[ $c_minor -gt $r_minor ]] && return 0
    [[ $c_minor -lt $r_minor ]] && return 1
    [[ $c_patch -gt $r_patch ]] && return 0
    [[ $c_patch -lt $r_patch ]] && return 1
    [[ $c_dev -ge $r_dev ]] && return 0
    return 1
}

# Simple semver comparison for Bun
# Returns 0 (true) if $1 >= $2
version_gte() {
    local current="$1"
    local required="$2"

    # Use sort -V for version comparison
    local lower
    lower=$(printf '%s\n%s' "$current" "$required" | sort -V | head -n1)
    [[ "$lower" == "$required" ]]
}

install_bun() {
    echo "Installing Bun..."
    curl -fsSL https://bun.sh/install | bash

    # Source shell config to get bun in PATH
    for rc in "$HOME/.bashrc" "$HOME/.zshrc" "$HOME/.profile" "$HOME/.bash_profile"; do
        if [[ -f "$rc" ]]; then
            # shellcheck source=/dev/null
            source "$rc" 2>/dev/null || true
        fi
    done

    # Also check common install locations
    if [[ -d "$HOME/.bun/bin" ]]; then
        export PATH="$HOME/.bun/bin:$PATH"
    fi

    if ! command -v bun &> /dev/null; then
        echo ""
        print_warning "Bun was installed but not found in PATH."
        print_warning "You may need to restart your terminal or run:"
        echo "  export PATH=\"\$HOME/.bun/bin:\$PATH\""
        exit 1
    fi

    print_success "Bun installed successfully!"
}

install_zig() {
    echo "Installing Zig..."

    local arch os
    arch=$(uname -m)
    os=$(uname -s | tr '[:upper:]' '[:lower:]')

    # Map architecture names
    case "$arch" in
        x86_64) arch="x86_64" ;;
        arm64|aarch64) arch="aarch64" ;;
        *)
            print_error "Unsupported architecture: $arch"
            exit 1
            ;;
    esac

    # Map OS names
    case "$os" in
        darwin) os="macos" ;;
        linux) os="linux" ;;
        *)
            print_error "Unsupported OS: $os"
            exit 1
            ;;
    esac

    local base_url="https://ziglang.org/builds"
    local filename="zig-${os}-${arch}-${ZIG_MIN_VERSION}.tar.xz"
    local url="${base_url}/${filename}"
    local install_dir="$HOME/.local/zig"

    echo "Downloading from: $url"

    mkdir -p "$install_dir"
    curl -fsSL "$url" | tar -xJ -C "$install_dir" --strip-components=1

    # Add to PATH for current session
    export PATH="$install_dir:$PATH"

    echo ""
    print_success "Zig installed to $install_dir"
    echo ""
    print_warning "Add to your shell config for persistent access:"
    echo "  export PATH=\"\$HOME/.local/zig:\$PATH\""

    if ! command -v zig &> /dev/null; then
        print_error "Zig installation failed - not found in PATH"
        exit 1
    fi
}

check_bun() {
    echo "Checking for Bun..."

    if ! command -v bun &> /dev/null; then
        print_warning "Bun is not installed."
        echo ""
        read -rp "Would you like to install Bun? [Y/n] " response
        case "$response" in
            [nN]*)
                echo "Skipping Bun installation."
                echo "Visit: https://bun.sh"
                exit 1
                ;;
            *)
                install_bun
                ;;
        esac
        return
    fi

    local bun_version
    bun_version=$(bun --version)
    echo "Found Bun $bun_version"

    if ! version_gte "$bun_version" "$BUN_MIN_VERSION"; then
        print_warning "Warning: Bun $bun_version is older than suggested $BUN_MIN_VERSION"
        echo "You may experience issues. Consider upgrading: bun upgrade"
    else
        print_success "Bun version OK"
    fi
}

check_zig() {
    echo ""
    echo "Checking for Zig..."

    if ! command -v zig &> /dev/null; then
        print_warning "Zig is not installed."
        echo ""
        read -rp "Would you like to install Zig? [Y/n] " response
        case "$response" in
            [nN]*)
                echo "Skipping Zig installation."
                echo "Visit: https://ziglang.org/download/"
                exit 1
                ;;
            *)
                install_zig
                ;;
        esac
        return
    fi

    local zig_version
    zig_version=$(zig version)
    echo "Found Zig $zig_version"

    if ! zig_version_gte "$zig_version" "$ZIG_MIN_VERSION"; then
        echo ""
        print_warning "Warning: Zig $zig_version may not be compatible."
        echo "Required: $ZIG_MIN_VERSION or higher"
        echo ""
        echo "To upgrade, download from: https://ziglang.org/download/"
        echo ""
        read -rp "Continue anyway? [y/N] " response
        case "$response" in
            [yY]*)
                echo "Continuing with current Zig version..."
                ;;
            *)
                exit 1
                ;;
        esac
    else
        print_success "Zig version OK"
    fi
}

run_bun_install() {
    echo ""
    echo "Installing dependencies with Bun..."
    cd "$PROJECT_ROOT"
    bun install
}

verify_setup() {
    echo ""
    echo "Verifying setup..."

    local all_ok=true

    if command -v bun &> /dev/null; then
        print_success "  Bun: OK"
    else
        print_error "  Bun: NOT FOUND"
        all_ok=false
    fi

    if command -v zig &> /dev/null; then
        print_success "  Zig: OK"
    else
        print_error "  Zig: NOT FOUND"
        all_ok=false
    fi

    if [[ -d "$PROJECT_ROOT/node_modules" ]]; then
        print_success "  Dependencies: OK"
    else
        print_error "  Dependencies: NOT INSTALLED"
        all_ok=false
    fi

    if $all_ok; then
        echo ""
        print_success "Setup complete!"
        echo ""
        echo "Next steps:"
        echo "  bun run ci        # Run all checks"
        echo "  cd games/mario && bun run dev  # Start a game dev server"
    fi
}

main() {
    print_header "Bloop Setup"
    echo ""

    load_config
    check_bun
    check_zig
    run_bun_install
    verify_setup
}

main "$@"
